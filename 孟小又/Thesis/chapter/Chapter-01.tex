\setcounter{chapter}{0}

\chapter{绪论}
\label{chap1}
\section{课题研究背景}
近年来，随着电子游戏、电影和虚拟现实等行业的快速发展，虚拟场景的渲染成为热门话题之一，很多游戏追求场景和真实世界的相似性，想做到以假乱真的效果，比如最近的热门游戏《绝地求生》，地图是一个岛屿，渲染的场景真实感较强。逼近真实的场景不仅使用全局光照等算法让光照更加真实，并且会渲染自然界中一些天气现象来让用户的沉浸感更强，感受游戏中的时间流逝或者氛围。雾，雨，云隙光和体积光都是场景中经常出现的自然现象。这些现象除了可以烘托场景的气氛，丰富场景的感情色彩外，还可以增加游戏的趣味性，比如很多热门游戏会推出迷雾关卡。

计算机图形学相关的研究一直致力于正确地重现这些物理现象，目前，市面上主流的游戏引擎都支持这些特效的渲染，比如瑞典DICE 游戏工作室的寒霜引擎和美国EPIC Games游戏制作团队的虚幻引擎。如图\ref{pic1-Volumetric-Fog-Light} 所示，图中四张子图都是使用这两个引擎的游戏渲染出来的特效，第四张子图来源于游戏《神佑》的场景，深夜的薄雾可以给用户一种神秘严肃的直观感受。
\begin{figure*}[!htb]
\makeatletter
\renewcommand{\@thesubfigure}{\hskip\subfiglabelskip}
\makeatother
    \centering
    \subfigure[寒霜引擎体积光]{
    \includegraphics[width=0.45\textwidth, height=3.5cm]{figures/Frostbite_Engine_1}}
    \subfigure[寒霜引擎体积雾]{
    \includegraphics[width=0.45\textwidth, height=3.5cm]{figures/Frostbite_Engine_2}}
     \subfigure[虚幻引擎体积光]{
    \includegraphics[width=0.45\textwidth, height=3.5cm]{figures/Unreal_1}}
    \subfigure[虚幻引擎体积雾]{
    \includegraphics[width=0.45\textwidth, height=3.5cm]{figures/Unreal_2}}
    \caption{游戏引擎模拟的体积光和体积雾效果}
    \label{pic1-Volumetric-Fog-Light}
\end{figure*}


上述自然现象产生的主要原因是光的散射。光的散射是一个很重要的物理现象，它是光线与传播介质中的粒子产生相互作用的结果。光线在通过不均匀的介质时，有一部分光线会偏离原有的路径，向多个方向发生散射。光线通过尘埃，云滴和雾时，都会发生散射现象。引起光散射的原因是传播介质中存在其他的物质微粒，或者传播介质本身密度的不均匀性。介质中粒子直径的大小和光线的波长会影响散射的效果。蓝色的天空是大气散射的结果，这种情况下，介质中的粒子直径比较小，波长短，频率高的偏蓝色光被偏折到我们眼睛内的概率大。体积光和体积雾同样是光散射的结果，在这两种现象中，介质中的粒子直径比较大。


因为传播介质中的每一个粒子都会影响光线的传播，所以模拟这些自然现象，通常需要花费很多内存资源和计算资源。开发者需要更多的内存去存储和传播介质相关的信息，并且需要计算传播过程中每个粒子对光线的影响。为了提高效率，很多游戏采用复杂度较低的算法去近似模拟这些现象，或者针对场景做一些特殊的优化，使得场景看上去有雾或者体积光的效果，这些方式生成的效果不够真实或者在动态场景中适应性较差。此外，很多追求场景画面质量的研究者致力于采用基于物理的方式去模拟这些现象，这些方法会在空间中离散地选取一些点作为介质中的粒子，考虑这些粒子的光照信息对相机的影响并得到最终的效果。通常采样点越多，并且光照计算越复杂得到的效果越好。但是这些基于物理的方法存在内存或者效率上的瓶颈。如何实时地，真实地重现这些物理现象成为计算机图形学的难点。


在电影制作中，开发者只考虑场景的画面质量，对渲染实时性没有要求。在渲染场景时，开发者会选用基于物理的方式对光线在介质中的传播过程进行模拟，渲染出每一帧的效果，然后再进行多帧混合得到最终结果。因为这些方法的光照更接近于真实世界，所以模拟的效果可以达到照片级的质量，但是处理这些方法需要巨大的计算量，电影中相对复杂的场景，渲染一帧画面的时间在一个小时左右，效率的限制使得这些方法不能在交互系统中采用。


游戏和基于实时渲染的应用在模拟这些现象时，由于设备性能或者实时性要求的限制，他们会采取简化的处理方式，取得视觉上类似的效果。本文算法主要用来模拟体积雾和体积光，所以国内外现状从
这两个方面进行分析。

\section{国内外研究现状}
体积雾和体积光，以及类似的大气散射现象在游戏和虚拟现实的场景中十分常见,效果和实时性是研究者考虑最多的两大因素。目前，国内外已经有很多与体积雾和体积光相关的研究。这些研究从目标性的不同，可以分为基于物理的渲染和基于屏幕空间的渲染。前者更偏重于渲染画面的质量，后者更偏重于渲染的实时性。共同点是这些算法都想在画面质量和实时性之间求取平衡。
\subsection{体积雾}
基于物理的体积雾的渲染算法使用更加接近实际物理理论的计算去模拟雾的形成。雾的颜色是由介质中粒子的散射光线决定，当介质中的粒子直径大于入射光的波长时，散射现象在靠近地面的部分表现为雾和烟，在高空中表现为云。在这些算法中，通常假设空间中存在一些粒子，每个粒子有自己的属性，比如密度，位置等等。通过计算，可以得出这些粒子的散射光线对眼睛的影响。

  \subsubsection{非实时渲染方法}
在电影中，为了追求照片级的画面质量，开发者会使用离线渲染去模拟这些大气散射现象。1984 年，James T. Kajiya和Brian P. Von Herzen\scite{kajiya1984ray}提出用光线投射算法计算大气散射相关的现象，并且用体密度去模拟传播介质中的粒子分布情况。1995 年Holly Rushmeier\scite{rushmeier1995rendering}引入蒙特卡洛积分来帮助光线散射步骤的计算。2008年Wojciech Jarosz等人\scite{jarosz2008beam}使用体积光子贴图技术来提高算法的效果和效率。但是这些算法由于效率的限制没有办法在交互系统和游戏中使用。

  \subsubsection{实时渲染方法}
    近年来，随着GPU(Graphics Processing Unit)性能的快速增长，电脑拥有高速的计算能力，研究人员可以将新的方法应用到模拟散射现象中。光线行进算法(Ray-marching)被很多学者应用到体积雾的模拟中。如2014 年，Egor Tusov 提出极线采样\scite{yusov2014high}的解决方案来提高效率，2014 年，游戏《杀戮地带：暗影坠落》\scite{vos2014volumetric}里面渲染体积雾的方法同样基于Ray-marching算法。目前，基于Ray-marching的模拟算法关注度比较高，这些算法考虑到空间中的每个粒子对光线的影响，并且算法的适应性相对于其他算法较好。但是现有的Ray-marching算法都是在二维纹理中完成，二维纹理中进行Ray-marching算法有以下几个缺点：
\begin{itemize}
\item 应用场景是单光源，传播介质密度均匀的场景，应用范围较窄，适应性不广泛。
\item GPU性能的极大提升使得开发者不再需要在低分辨率的二维纹理中做Ray-marching，这可以避免锯齿状的走样。但是大部分向上采样的算法，例如双边上采样\scite{kopf2007joint}可能会遗漏一些不明显的几何特征或者产生一些高对比度的伪影。
\item 大部分模拟体积雾的算法不能兼容于前向着色渲染管线，或者在透明物体的处理中需要额外的计算。
\end{itemize}


为了满足实时渲染的要求，游戏和应用会简化体积雾的模拟。很多体积雾的渲染算法在屏幕空间下完成以提高效率。游戏中最普遍的全局雾是基于屏幕空间算法的典型例子，这个算法中雾的效果只和场景的深度和高度有关，在后处理中得到雾的混合因子，与原有场景的颜色进行混合，给人视觉上类似的雾效。2006 年，Carsten Wenzel \scite{wenzel2006real}提出一种指数相关的数学公式来计算雾的混合因子，可以让雾看起来更加贴近真实。2014 年，郭[等人\scite{guo2014foggy}用柏林噪声去干扰雾的空间分布，在场景中生成各项异性的雾。这个算法使用二维的柏林噪声。在场景深度变化时，雾的分布不会改变。上述这些方法都可以近似地模拟雾的效果，但是在有动态光源和场景发生变化的情况下，算法适应性和雾的真实性较差。

\subsection{体积光}
早期游戏由于硬件性能的限制，BillBoard贴片技术和径向模糊是经常使用的两种方式。BillBoard 贴片技术原理如图\ref{pic_billboard}所示：用图像处理软件生成一个随机的明暗条纹噪声纹理，然后叠加遮罩纹理，使其看起来像光束。将处理好的纹理放置在场景中可能存在体积光的位置，可以产生简单的体积光效果。这种处理方式只能在某些角度效果较好，动态场景适应性较差。
\begin{figure}[htbp]
    \centering
    \includegraphics[width=.95\linewidth, height=6.0cm]{figures/Billboard}
    \caption{BillBoard生成体积光}
    \label{pic_billboard}
\end{figure}

径向模糊算法是一种后处理方法，主要用来表现太阳或者月亮的散射效果。径向模糊算法步骤如下：渲染完整个场景以后，提取可见场景中高亮的部分，然后对高亮的区域进行处理，处理步骤如图
\ref{pic_RBlur} 所示，从当前像素点出发，向中心区域移动，每次移动一定的步长，在这个方向上进行采样，将所有的采样点的亮度值相加作为当前像素的亮度值，然后把径向模糊后的高亮层和原场景图进行混合得到最终的效果。径向模糊优点是实现简单，消耗资源小，效果差强人意。缺点也很明显，在光源不可见的情况下无法进行径向模糊。2008 年，Tiago Sousa\scite{sousa2008crysis} 在孤岛危机游戏中使用另外一种后处理的方式模拟光柱和云隙光。让美工人员提前生成不同场景的光的效果，根据场景不同和时间的不同，选择需要的效果图和原场景进行混合。这种算法自适应能力不强，需要针对不同场景进行优化。
\begin{figure}[htbp]
    \centering
    \includegraphics[width=.7\linewidth, height=6.0cm]{figures/RBlur}
    \caption{BillBoard生成体积光}
    \label{pic_RBlur}
\end{figure}


随着硬件性能的不断提升，渲染体积光的算法也在质量上得到很大的改善。最近主流的体积光渲染算法基于Ray-marching算法和阴影贴图技术。2008年Chris Wyman 和Shaun Ramsey\scite{wyman2008interactive}提出将影域体算法和Ray-marching算法相结合来模拟体积光的效果。但是这个算法只适用于光源对相机可见的情况，此外，这个算法在二维纹理中进行Ray-marching，会存在边缘产物和走样的情况。2009 年，Balázs Tóth和Tamás Umenhoffer\scite{toth2009real}在此基础上提出改进，将阴影贴图技术应用到体积光的模拟中。因为户外大型场景中模型细节丰富，数量众多，所以使用阴影贴图技术存在两个技术难点：第一个是内存消耗和效率问题，第二个是阴影效果走样。近年来，很多阴影算法都致力于滤波低分辨率的阴影贴图来提高阴影的质量。如2007年，Kevin Myers\scite{myers2007variance}提出的方差阴影贴图和Thomas Annen\scite{annen2007convolution}等人提出的卷积阴影图。2008 年Thomas Annen等人\scite{annen2008exponential}又提出指数阴影贴图。2010 年，Jon Jansen等人\scite{jansen2010fourier}将傅里叶不透明贴图应用到阴影技术中。 2011 年，Cyril Delalandre\scite{delalandre2011transmittance} 等人提出了透射率函数贴图。这些算法都是在效率和效果中寻找平衡点，通过滤波技术去解决阴影走样问题。2014 年，游戏《杀戮地带：暗影坠落》里面渲染体积光的算法使用的阴影技术是级联阴影\scite{dimitrov2007cascaded}，由于级联阴影的贴图中存储的阴影细节更加丰富，所以这个算法在大型户外场景渲染中有一定的优势。级联阴影的缺点是需要更多的内存去存储中间结果，本文算法将级联阴影算法和指数阴影贴图技术相结合，生成低分辨率的阴影贴图缓解内存压力。
\section{本文主要工作}

Ray-marching算法和阴影贴图算法相结合来模拟体积雾和体积光是近年来认可度比较高的算法，本文算法在此基础上进行改进。本文工作可以从三个部分进行描述，首先针对Ray-marching算法的效率与阴影贴图算法的内存和效果进行改进，其次将粒子的光照计算部分和其他渲染步骤解耦，提高算法的灵活性和兼容性，最后将原始的场景和本文算法生成的特效相结合，证明本文算法对复杂场景适应性较好。本文算法的改进点和使用技术如下。
\begin{itemize}
\item 使用计算着色器完成Ray-marching算法中的光照计算和求解散射方程步骤，计算着色器可以提高效率，并且我们将中间结果存放在三维纹理中，在后续步骤中可以多次使用，避免重复计算；
\item 运用指数阴影技术去滤波级联阴影的贴图，这个做法可以不必使用过大的阴影贴图去增加内存的负担，并且可以处理阴影边缘的走样；
\item 本文算法可以兼容多种渲染管线并且支持复杂场景的特效应用，比如多光源场景和存在透明物体的场景；
\end{itemize}

\section{本文组织结构}
本文共分为五章，具体的章节安排如下：

第一章，绪论。首先介绍体积雾和体积光课题的研究背景、研究意义；然后介绍了体积雾和体积光的国内外研究现状，包括：基于物理的体积光和体积雾、基于屏幕空间的体积光和体积雾等，最后介绍了本文的内容分布和组织结构。

第二章，相关技术研究。介绍与本文算法实现相关的理论知识和技术，包括光线传播概要，散射现象，散射模型，二维Ray-marching算法等。

第三章，算法实现细节。详细介绍本文方法的实现细节和关键技术，包括级联阴影算法的实现和优化，单个粒子的散射计算，多光源下内散射光线的预处理，求解散射积分方程等。

第四章，实验结果与分析。针对本文所提出的改进点进行实验，给出效率和效果上的对比实验，并分析原因，证明本文算法的正确性和可行性。

第五章，总结与展望。对本文提出的方法进行归纳、总结，并分析不足之处，提出未来工作的改进方法和研究方向。

\section{本章小结}
本章首先概述了本文工作的研究背景与意义，体积雾和体积光在游戏和应用中有广泛的应用，其次介绍了体积雾和体积光的国内外现状，包括基于物理的渲染方法和基于屏幕的渲染方法等，分析现有算法的优点与不足，然后概括了本文的主要工作，主要工作包括本文算法对原有算法改进和本文算法在实际应用中的正确性和灵活性。最后介绍了本文的组织结构。